---
import PublicLayout from '@layouts/PublicLayout.astro';
import { supabase } from '@lib/supabase';

// Get access token from cookies (set by client-side auth)
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let userId = null;
let userOrders: any[] = [];
let fetchError = null;

// Try to get session from tokens
if (accessToken && refreshToken) {
  const { data: { session }, error: sessionError } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (session?.user) {
    userId = session.user.id;

    // Fetch user orders from database
    const { data: orders, error } = await supabase
      .from('orders')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error fetching orders:', error);
      fetchError = error.message;
    } else {
      userOrders = orders || [];
    }
  }
}

const formatPrice = (cents: number) => {
  // Convert cents to dollars for display
  return new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'EUR',
  }).format(cents / 100);
};

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('es-MX', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};

const getStatusBadge = (status: string) => {
  const statusConfig: Record<string, { color: string; label: string }> = {
    completed: { color: 'bg-green-500/20 text-green-400 border-green-500', label: 'Completado' },
    pending: { color: 'bg-yellow-500/20 text-yellow-400 border-yellow-500', label: 'Pendiente' },
    paid: { color: 'bg-blue-500/20 text-blue-400 border-blue-500', label: 'Pagado' },
    processing: { color: 'bg-cyan-500/20 text-cyan-400 border-cyan-500', label: 'Procesando' },
    shipped: { color: 'bg-indigo-500/20 text-indigo-400 border-indigo-500', label: 'Enviado' },
    delivered: { color: 'bg-emerald-500/20 text-emerald-400 border-emerald-500', label: 'Entregado' },
    failed: { color: 'bg-red-500/20 text-red-400 border-red-500', label: 'Fallido' },
    cancelled: { color: 'bg-gray-500/20 text-gray-400 border-gray-500', label: 'Cancelado' },
    refunded: { color: 'bg-purple-500/20 text-purple-400 border-purple-500', label: 'Reembolsado' },
  };
  
  return statusConfig[status] || statusConfig.pending;
};

// Determinar qu√© acciones est√°n disponibles para cada pedido
const canCancel = (status: string) => ['pending', 'paid', 'processing'].includes(status);
const canReturn = (status: string) => status === 'delivered';
---

<PublicLayout title="Mis Pedidos" description="Historial de pedidos">
  <div class="min-h-screen bg-brand-black">
    <div class="max-w-6xl mx-auto px-4 py-12">
      <h1 class="text-4xl font-display font-bold text-white uppercase mb-8 tracking-tight">
        Mis Pedidos
      </h1>

      {/* Check if not logged in */}
      {!userId && (
        <div class="bg-brand-dark rounded-lg p-8 text-center">
          <div class="text-6xl mb-4 text-neutral-500">‚Ä¢</div>
          <p class="text-neutral-400 text-lg mb-6">
            Debes iniciar sesi√≥n para ver tus pedidos
          </p>
          <a 
            href="/auth/login?redirect=/pedidos" 
            class="inline-block bg-brand-red text-white px-8 py-3 font-bold uppercase hover:bg-brand-orange transition-colors"
          >
            Iniciar Sesi√≥n
          </a>
        </div>
      )}

      {/* Error message */}
      {fetchError && (
        <div class="bg-red-900/30 border border-red-500 p-4 mb-6 rounded">
          <p class="text-red-400">Error cargando pedidos: {fetchError}</p>
          <p class="text-neutral-500 text-sm mt-2">
            Si el problema persiste, verifica que la tabla 'orders' exista en Supabase.
          </p>
        </div>
      )}

      {/* No orders */}
      {userId && userOrders.length === 0 && !fetchError && (
        <div class="bg-brand-dark rounded-lg p-8 text-center">
          <div class="text-6xl mb-4 text-neutral-500">‚Ä¢</div>
          <p class="text-neutral-400 text-lg mb-6">
            No tienes pedidos a√∫n
          </p>
          <a 
            href="/productos" 
            class="inline-block bg-brand-red text-white px-8 py-3 font-bold uppercase hover:bg-brand-orange transition-colors"
          >
            Explorar Productos
          </a>
        </div>
      )}

      {/* Orders list */}
      {userId && userOrders.length > 0 && (
        <div class="space-y-6">
          {userOrders.map((order: any) => {
            const statusConfig = getStatusBadge(order.status);
            const items = Array.isArray(order.items) ? order.items : [];
            
            return (
              <div class="bg-brand-dark border border-brand-gray rounded-lg overflow-hidden" data-order-id={order.id}>
                {/* Order Header */}
                <div class="bg-brand-gray p-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div>
                    <p class="text-neutral-500 text-sm uppercase">
                      Pedido #{order.stripe_session_id?.slice(-8).toUpperCase() || order.id.slice(0,8).toUpperCase()}
                    </p>
                    <p class="text-white text-sm mt-1">
                      {formatDate(order.created_at)}
                    </p>
                  </div>
                  <div class="text-right">
                    <p class={`inline-block px-3 py-1 rounded border text-sm font-bold ${statusConfig.color}`}>
                      {statusConfig.label}
                    </p>
                    {order.return_status && (
                      <p class="inline-block ml-2 px-3 py-1 rounded border text-sm font-bold bg-amber-500/20 text-amber-400 border-amber-500">
                        Devoluci√≥n: {order.return_status === 'requested' ? 'Solicitada' : order.return_status === 'approved' ? 'Aprobada' : order.return_status === 'received' ? 'Recibida' : 'Reembolsada'}
                      </p>
                    )}
                    <p class="text-white font-bold text-2xl mt-2">
                      {formatPrice(order.total_amount || 0)}
                    </p>
                  </div>
                </div>

                {/* Order Items */}
                <div class="p-6">
                  <h3 class="text-white font-bold mb-4 text-sm uppercase">Productos ({items.length})</h3>
                  <div class="space-y-3">
                    {items.length > 0 ? (
                      items.map((item: any, idx: number) => {
                        // Los items se guardan como: {id, name, brand, price, qty, size, img}
                        const itemName = item.name || item.product?.name || 'Producto';
                        const itemBrand = item.brand || item.product?.brand || '';
                        const itemImage = item.img || item.product?.images?.[0];
                        const itemPrice = item.price || item.product?.price || 0;
                        const itemQty = item.qty || item.quantity || 1;
                        
                        return (
                          <div class="flex items-center justify-between bg-brand-black p-4 rounded">
                            <div class="flex items-center gap-4 flex-1">
                              {itemImage && (
                                <img 
                                  src={itemImage} 
                                  alt={itemName}
                                  class="w-16 h-16 object-cover rounded"
                                />
                              )}
                              <div>
                                {itemBrand && (
                                  <p class="text-brand-red font-bold text-sm">
                                    {itemBrand}
                                  </p>
                                )}
                                <p class="text-white font-semibold">
                                  {itemName}
                                </p>
                                <p class="text-neutral-500 text-sm">
                                  Talla: {item.size} | Cantidad: {itemQty}
                                </p>
                              </div>
                            </div>
                            <p class="text-brand-orange font-bold text-lg">
                              {formatPrice(itemPrice * itemQty)}
                            </p>
                          </div>
                        );
                      })
                    ) : (
                      <p class="text-neutral-500 text-sm bg-brand-black p-4 rounded">
                        Sin detalles de productos disponibles
                      </p>
                    )}
                  </div>
                </div>

                {/* Shipping Info */}
                {(order.shipping_name || order.billing_email) && (
                  <div class="border-t border-brand-gray p-6 bg-brand-black">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {order.shipping_name && (
                        <div>
                          <p class="text-neutral-500 text-sm uppercase mb-2">Env√≠o a</p>
                          <p class="text-white font-semibold">{order.shipping_name}</p>
                          {order.shipping_address && (
                            <p class="text-neutral-400 text-sm mt-1">
                              {order.shipping_address?.line1}
                              {order.shipping_address?.line2 && `, ${order.shipping_address.line2}`}
                              <br />
                              {order.shipping_address?.city}, {order.shipping_address?.state} {order.shipping_address?.postal_code}
                              <br />
                              {order.shipping_address?.country}
                            </p>
                          )}
                        </div>
                      )}
                      {order.billing_email && (
                        <div>
                          <p class="text-neutral-500 text-sm uppercase mb-2">Email de contacto</p>
                          <p class="text-white font-semibold">{order.billing_email}</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Order Actions */}
                <div class="border-t border-brand-gray p-6 bg-brand-dark flex flex-wrap gap-3">
                  {/* Download Invoice Button - Always available */}
                  <button
                    type="button"
                    class="download-invoice-btn px-6 py-2 border-2 border-brand-orange text-brand-orange font-bold uppercase text-sm hover:bg-brand-orange hover:text-black transition-colors rounded"
                    data-order-id={order.id}
                  >
                    üìÑ Descargar Factura
                  </button>

                  {/* Cancel and Return buttons */}
                  {(canCancel(order.status) || canReturn(order.status)) && !order.return_status && (
                    <>
                      {canCancel(order.status) && (
                        <button
                          type="button"
                          class="cancel-order-btn px-6 py-2 border-2 border-red-500 text-red-500 font-bold uppercase text-sm hover:bg-red-500 hover:text-white transition-colors rounded"
                          data-order-id={order.id}
                        >
                          Cancelar Pedido
                        </button>
                      )}
                      {canReturn(order.status) && (
                        <button
                          type="button"
                          class="return-order-btn px-6 py-2 border-2 border-amber-500 text-amber-500 font-bold uppercase text-sm hover:bg-amber-500 hover:text-white transition-colors rounded"
                          data-order-id={order.id}
                        >
                          Solicitar Devoluci√≥n
                        </button>
                      )}
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  </div>

  {/* Modal de Confirmaci√≥n */}
  <div id="confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
    <div class="bg-brand-dark border border-brand-gray rounded-lg max-w-md w-full mx-4 p-6">
      <h3 id="modal-title" class="text-xl font-bold text-white mb-4"></h3>
      <p id="modal-message" class="text-neutral-400 mb-6"></p>
      <div id="modal-extra" class="mb-6"></div>
      <div class="flex gap-3 justify-end">
        <button id="modal-cancel" class="px-6 py-2 border border-neutral-500 text-neutral-400 rounded hover:bg-neutral-700 transition-colors">
          Cancelar
        </button>
        <button id="modal-confirm" class="px-6 py-2 bg-red-600 text-white font-bold rounded hover:bg-red-700 transition-colors">
          Confirmar
        </button>
      </div>
    </div>
  </div>
</PublicLayout>

<script>
  // Modal handling
  const modal = document.getElementById('confirm-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  const modalExtra = document.getElementById('modal-extra');
  const modalCancel = document.getElementById('modal-cancel');
  const modalConfirm = document.getElementById('modal-confirm');
  
  let currentAction: (() => Promise<void>) | null = null;

  function showModal(title: string, message: string, extra: string, confirmAction: () => Promise<void>) {
    if (modalTitle) modalTitle.textContent = title;
    if (modalMessage) modalMessage.textContent = message;
    if (modalExtra) modalExtra.innerHTML = extra;
    currentAction = confirmAction;
    modal?.classList.remove('hidden');
    modal?.classList.add('flex');
  }

  function hideModal() {
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
    currentAction = null;
  }

  modalCancel?.addEventListener('click', hideModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) hideModal();
  });

  modalConfirm?.addEventListener('click', async () => {
    if (currentAction) {
      const btn = modalConfirm as HTMLButtonElement;
      btn.disabled = true;
      btn.textContent = 'Procesando...';
      await currentAction();
      btn.disabled = false;
      btn.textContent = 'Confirmar';
      hideModal();
      window.location.reload();
    }
  });

  // Download invoice
  document.querySelectorAll('.download-invoice-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const orderId = btn.getAttribute('data-order-id');
      try {
        const response = await fetch(`/api/orders/download-invoice?id=${orderId}`);
        if (!response.ok) {
          throw new Error('Error al descargar la factura');
        }

        // Crear blob y descargar
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Factura_${orderId?.slice(0, 8) || 'factura'}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        alert(error instanceof Error ? error.message : 'Error al descargar la factura');
      }
    });
  });

  // Cancel order
  document.querySelectorAll('.cancel-order-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const orderId = btn.getAttribute('data-order-id');
      showModal(
        '‚ùå Cancelar Pedido',
        '¬øEst√°s seguro de que quieres cancelar este pedido? Esta acci√≥n no se puede deshacer.',
        '<div class="bg-brand-black p-4 rounded"><label class="text-sm text-neutral-400 block mb-2">Motivo de la cancelaci√≥n (opcional)</label><input type="text" id="cancel-reason" class="w-full bg-brand-gray border border-neutral-600 rounded px-3 py-2 text-white" placeholder="Ej: Cambi√© de opini√≥n"></div>',
        async () => {
          const reason = (document.getElementById('cancel-reason') as HTMLInputElement)?.value || '';
          const response = await fetch('/api/orders/cancel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId, reason }),
          });
          const data = await response.json();
          if (!response.ok) {
            alert(data.error || 'Error al cancelar el pedido');
          }
        }
      );
    });
  });

  // Return order
  document.querySelectorAll('.return-order-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const orderId = btn.getAttribute('data-order-id');
      showModal(
        'üì¶ Solicitar Devoluci√≥n',
        'Recibir√°s un email con las instrucciones para enviar el producto de vuelta.',
        `<div class="bg-amber-500/10 border border-amber-500/30 p-4 rounded text-sm text-amber-200">
          <p class="font-bold mb-2">Pol√≠tica de devoluciones:</p>
          <ul class="list-disc list-inside space-y-1 text-amber-100/80">
            <li>Los productos deben estar en su estado original</li>
            <li>Tienes 30 d√≠as desde la entrega para solicitar la devoluci√≥n</li>
            <li>Los gastos de env√≠o de la devoluci√≥n corren por tu cuenta</li>
            <li>El reembolso se procesar√° en 5-10 d√≠as h√°biles</li>
          </ul>
        </div>`,
        async () => {
          const response = await fetch('/api/orders/return', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId }),
          });
          const data = await response.json();
          if (!response.ok) {
            alert(data.error || 'Error al solicitar la devoluci√≥n');
          }
        }
      );
    });
  });
</script>
