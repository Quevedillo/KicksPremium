---
import PublicLayout from '@layouts/PublicLayout.astro';
import { supabase } from '@lib/supabase';

// Obtener tokens de cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let user = null;
let profile = null;

if (accessToken && refreshToken) {
  const { data: sessionData } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  
  if (sessionData?.user) {
    user = sessionData.user;
    
    // Obtener perfil
    const { data: profileData } = await supabase
      .from('user_profiles')
      .select('*')
      .eq('id', user.id)
      .single();
    
    profile = profileData;
  }
}

// Redirigir si no está autenticado
if (!user) {
  return Astro.redirect('/auth/login?redirect=/mi-cuenta');
}
---

<PublicLayout title="Mi Cuenta" description="Gestiona tu cuenta de usuario">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <div class="bg-white rounded-lg shadow p-6">
      <h1 class="text-3xl font-display font-bold text-brand-navy mb-4">
        Mi Cuenta
      </h1>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* Sidebar */}
        <div class="md:col-span-1">
          <nav class="space-y-2">
            <a href="/mi-cuenta" class="block px-4 py-2 bg-brand-navy text-white rounded font-semibold">
              Mi Perfil
            </a>
            <a href="/pedidos" class="block px-4 py-2 text-brand-navy hover:bg-neutral-100 rounded">
              Mis Pedidos
            </a>
          </nav>
        </div>

        {/* Main Content */}
        <div class="md:col-span-2 space-y-8">
          
          {/* Información del perfil */}
          <section>
            <h2 class="text-xl font-semibold text-brand-navy mb-4 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg>
              Información de la cuenta
            </h2>
            <div class="bg-neutral-50 rounded-lg p-4 space-y-3">
              <div class="flex justify-between items-center border-b border-neutral-200 pb-3">
                <span class="text-neutral-600">Email</span>
                <span class="font-medium text-brand-navy">{user?.email}</span>
              </div>
              <div class="flex justify-between items-center border-b border-neutral-200 pb-3">
                <span class="text-neutral-600">Nombre</span>
                <span class="font-medium text-brand-navy">{profile?.full_name || 'No especificado'}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-neutral-600">Miembro desde</span>
                <span class="font-medium text-brand-navy">
                  {new Date(user?.created_at || '').toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </span>
              </div>
            </div>
          </section>

          {/* Cambiar Contraseña */}
          <section>
            <h2 class="text-xl font-semibold text-brand-navy mb-4 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
              </svg>
              Cambiar Contraseña
            </h2>
            
            <form id="password-form" class="bg-neutral-50 rounded-lg p-4 space-y-4">
              <div>
                <label for="currentPassword" class="block text-sm font-medium text-neutral-700 mb-1">
                  Contraseña actual
                </label>
                <input 
                  type="password" 
                  id="currentPassword" 
                  name="currentPassword"
                  required
                  minlength="6"
                  class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent"
                  placeholder="••••••••"
                />
              </div>
              
              <div>
                <label for="newPassword" class="block text-sm font-medium text-neutral-700 mb-1">
                  Nueva contraseña
                </label>
                <input 
                  type="password" 
                  id="newPassword" 
                  name="newPassword"
                  required
                  minlength="6"
                  class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent"
                  placeholder="Mínimo 6 caracteres"
                />
              </div>
              
              <div>
                <label for="confirmPassword" class="block text-sm font-medium text-neutral-700 mb-1">
                  Confirmar nueva contraseña
                </label>
                <input 
                  type="password" 
                  id="confirmPassword" 
                  name="confirmPassword"
                  required
                  minlength="6"
                  class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent"
                  placeholder="Repite la contraseña"
                />
              </div>
              
              <div id="password-message" class="hidden rounded-lg p-3 text-sm"></div>
              
              <button 
                type="submit"
                id="submit-btn"
                class="w-full bg-brand-navy text-white py-3 rounded-lg font-semibold hover:bg-opacity-90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Cambiar Contraseña
              </button>
            </form>
          </section>

          {/* Cerrar Sesión */}
          <section>
            <button 
              id="logout-btn"
              class="w-full border-2 border-red-500 text-red-500 py-3 rounded-lg font-semibold hover:bg-red-50 transition-colors"
            >
              Cerrar Sesión
            </button>
          </section>
          
        </div>
      </div>
    </div>
  </div>
</PublicLayout>

<script>
  // Cambio de contraseña
  const form = document.getElementById('password-form') as HTMLFormElement;
  const messageDiv = document.getElementById('password-message') as HTMLDivElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  
  function showMessage(message: string, isError: boolean) {
    messageDiv.textContent = message;
    messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
    if (isError) {
      messageDiv.classList.add('bg-red-100', 'text-red-800');
    } else {
      messageDiv.classList.add('bg-green-100', 'text-green-800');
    }
  }
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const currentPassword = (document.getElementById('currentPassword') as HTMLInputElement).value;
    const newPassword = (document.getElementById('newPassword') as HTMLInputElement).value;
    const confirmPassword = (document.getElementById('confirmPassword') as HTMLInputElement).value;
    
    // Validar que las contraseñas coincidan
    if (newPassword !== confirmPassword) {
      showMessage('Las contraseñas no coinciden', true);
      return;
    }
    
    // Validar longitud mínima
    if (newPassword.length < 6) {
      showMessage('La contraseña debe tener al menos 6 caracteres', true);
      return;
    }
    
    // Deshabilitar botón
    submitBtn.disabled = true;
    submitBtn.textContent = 'Actualizando...';
    
    try {
      const response = await fetch('/api/auth/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ currentPassword, newPassword }),
      });
      
      const data = await response.json();
      
      if (response.ok) {
        showMessage('¡Contraseña actualizada correctamente!', false);
        form.reset();
      } else {
        showMessage(data.error || 'Error al cambiar la contraseña', true);
      }
    } catch (error) {
      showMessage('Error de conexión. Inténtalo de nuevo.', true);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Cambiar Contraseña';
    }
  });
  
  // Cerrar sesión
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    try {
      await fetch('/api/auth/logout', { method: 'POST' });
      window.location.href = '/';
    } catch (error) {
      console.error('Error al cerrar sesión:', error);
    }
  });
</script>
