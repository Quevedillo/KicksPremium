---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

// Verificar autenticación de admin
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let isAdmin = false;
let discountCodes: any[] = [];

if (accessToken && refreshToken) {
  const { data: sessionData } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (sessionData?.user) {
    const { data: profile } = await supabase
      .from('user_profiles')
      .select('is_admin')
      .eq('id', sessionData.user.id)
      .single();
    
    isAdmin = profile?.is_admin || false;

    if (isAdmin) {
      const { data: codes } = await supabase
        .from('discount_codes')
        .select('*')
        .order('created_at', { ascending: false });
      
      discountCodes = codes || [];
    }
  }
}

if (!isAdmin) {
  return Astro.redirect('/admin');
}

const formatDate = (date: string | null) => {
  if (!date) return 'Sin fecha';
  return new Date(date).toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

const formatPrice = (cents: number) => `€${(cents / 100).toFixed(2)}`;
---

<AdminLayout title="Códigos de Descuento">
  <div class="p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-brand-navy">Códigos de Descuento</h1>
      <button
        id="new-code-btn"
        class="bg-brand-navy text-white px-6 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-colors"
      >
        + Nuevo Código
      </button>
    </div>

    {/* Estadísticas */}
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-neutral-500">Códigos Activos</p>
        <p class="text-2xl font-bold text-green-600">
          {discountCodes.filter(c => c.is_active).length}
        </p>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-neutral-500">Total de Usos</p>
        <p class="text-2xl font-bold text-brand-navy">
          {discountCodes.reduce((acc, c) => acc + (c.current_uses || 0), 0)}
        </p>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-neutral-500">Expirados</p>
        <p class="text-2xl font-bold text-red-500">
          {discountCodes.filter(c => c.expires_at && new Date(c.expires_at) < new Date()).length}
        </p>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-neutral-500">Códigos Totales</p>
        <p class="text-2xl font-bold text-neutral-700">{discountCodes.length}</p>
      </div>
    </div>

    {/* Tabla de códigos */}
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <table class="w-full">
        <thead class="bg-neutral-100">
          <tr>
            <th class="text-left p-4 font-semibold text-neutral-700">Código</th>
            <th class="text-left p-4 font-semibold text-neutral-700">Descuento</th>
            <th class="text-left p-4 font-semibold text-neutral-700">Mín. Compra</th>
            <th class="text-left p-4 font-semibold text-neutral-700">Usos</th>
            <th class="text-left p-4 font-semibold text-neutral-700">Válido hasta</th>
            <th class="text-left p-4 font-semibold text-neutral-700">Estado</th>
            <th class="text-left p-4 font-semibold text-neutral-700">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {discountCodes.map((code) => {
            const isExpired = code.expires_at && new Date(code.expires_at) < new Date();
            const isAtLimit = code.max_uses && code.current_uses >= code.max_uses;
            
            return (
              <tr class="border-t border-neutral-200 hover:bg-neutral-50">
                <td class="p-4">
                  <span class="font-mono font-bold text-brand-navy bg-neutral-100 px-2 py-1 rounded">
                    {code.code}
                  </span>
                  {code.description && (
                    <p class="text-xs text-neutral-500 mt-1">{code.description}</p>
                  )}
                </td>
                <td class="p-4">
                  <span class="font-semibold text-green-600">
                    {code.discount_type === 'percentage' 
                      ? `${code.discount_value}%` 
                      : formatPrice(code.discount_value)}
                  </span>
                </td>
                <td class="p-4 text-neutral-600">
                  {code.min_purchase > 0 ? formatPrice(code.min_purchase) : '-'}
                </td>
                <td class="p-4">
                  <span class="font-semibold">{code.current_uses || 0}</span>
                  <span class="text-neutral-400">
                    /{code.max_uses || '∞'}
                  </span>
                </td>
                <td class="p-4 text-sm">
                  {formatDate(code.expires_at)}
                </td>
                <td class="p-4">
                  {!code.is_active ? (
                    <span class="px-2 py-1 bg-neutral-200 text-neutral-600 rounded text-xs font-semibold">
                      Desactivado
                    </span>
                  ) : isExpired ? (
                    <span class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs font-semibold">
                      Expirado
                    </span>
                  ) : isAtLimit ? (
                    <span class="px-2 py-1 bg-amber-100 text-amber-600 rounded text-xs font-semibold">
                      Agotado
                    </span>
                  ) : (
                    <span class="px-2 py-1 bg-green-100 text-green-600 rounded text-xs font-semibold">
                      Activo
                    </span>
                  )}
                </td>
                <td class="p-4">
                  <div class="flex gap-2">
                    <button
                      class="toggle-code-btn text-sm px-3 py-1 border rounded hover:bg-neutral-100 transition-colors"
                      data-id={code.id}
                      data-active={code.is_active}
                    >
                      {code.is_active ? 'Desactivar' : 'Activar'}
                    </button>
                    <button
                      class="delete-code-btn text-sm px-3 py-1 border border-red-300 text-red-600 rounded hover:bg-red-50 transition-colors"
                      data-id={code.id}
                    >
                      Eliminar
                    </button>
                  </div>
                </td>
              </tr>
            );
          })}
          {discountCodes.length === 0 && (
            <tr>
              <td colspan="7" class="p-8 text-center text-neutral-500">
                No hay códigos de descuento. Crea uno nuevo.
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>

  {/* Modal para crear código */}
  <div id="new-code-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
      <h2 class="text-xl font-bold text-brand-navy mb-4">Nuevo Código de Descuento</h2>
      
      <form id="new-code-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-1">Código</label>
          <input
            type="text"
            name="code"
            required
            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent uppercase"
            placeholder="SUMMER20"
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-1">Descripción (opcional)</label>
          <input
            type="text"
            name="description"
            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent"
            placeholder="Descuento de verano"
          />
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-1">Tipo de descuento</label>
            <select
              name="discount_type"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent"
            >
              <option value="percentage">Porcentaje (%)</option>
              <option value="fixed">Monto fijo (€)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-1">Valor</label>
            <input
              type="number"
              name="discount_value"
              required
              min="1"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent"
              placeholder="10"
            />
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-1">Compra mínima (€)</label>
            <input
              type="number"
              name="min_purchase"
              min="0"
              value="0"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-1">Usos máximos</label>
            <input
              type="number"
              name="max_uses"
              min="0"
              placeholder="Ilimitado"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent"
            />
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-1">Fecha de expiración (opcional)</label>
          <input
            type="date"
            name="expires_at"
            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-navy focus:border-transparent"
          />
        </div>
        
        <div class="flex gap-3 pt-4">
          <button
            type="button"
            id="cancel-modal-btn"
            class="flex-1 px-4 py-2 border rounded-lg hover:bg-neutral-100 transition-colors"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-brand-navy text-white rounded-lg font-semibold hover:bg-opacity-90 transition-colors"
          >
            Crear Código
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script>
  const modal = document.getElementById('new-code-modal');
  const newCodeBtn = document.getElementById('new-code-btn');
  const cancelBtn = document.getElementById('cancel-modal-btn');
  const form = document.getElementById('new-code-form') as HTMLFormElement;

  // Abrir modal
  newCodeBtn?.addEventListener('click', () => {
    modal?.classList.remove('hidden');
    modal?.classList.add('flex');
  });

  // Cerrar modal
  cancelBtn?.addEventListener('click', () => {
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
  });

  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  });

  // Crear código
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    
    const code = formData.get('code')?.toString().toUpperCase();
    const description = formData.get('description')?.toString();
    const discount_type = formData.get('discount_type')?.toString();
    const discount_value = parseInt(formData.get('discount_value')?.toString() || '0');
    const min_purchase = parseInt(formData.get('min_purchase')?.toString() || '0') * 100; // Convertir a céntimos
    const max_uses = formData.get('max_uses')?.toString() ? parseInt(formData.get('max_uses')?.toString() || '0') : null;
    const expires_at = formData.get('expires_at')?.toString() || null;

    try {
      const response = await fetch('/api/admin/discount-codes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          code,
          description,
          discount_type,
          discount_value: discount_type === 'fixed' ? discount_value * 100 : discount_value,
          min_purchase,
          max_uses,
          expires_at: expires_at ? new Date(expires_at).toISOString() : null,
        }),
      });

      const data = await response.json();

      if (response.ok) {
        window.location.reload();
      } else {
        alert(data.error || 'Error al crear el código');
      }
    } catch (error) {
      alert('Error de conexión');
    }
  });

  // Toggle estado
  document.querySelectorAll('.toggle-code-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      const isActive = btn.getAttribute('data-active') === 'true';
      
      try {
        const response = await fetch(`/api/admin/discount-codes/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_active: !isActive }),
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        alert('Error al actualizar');
      }
    });
  });

  // Eliminar código
  document.querySelectorAll('.delete-code-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('¿Estás seguro de eliminar este código?')) return;
      
      const id = btn.getAttribute('data-id');
      
      try {
        const response = await fetch(`/api/admin/discount-codes/${id}`, {
          method: 'DELETE',
        });

        if (response.ok) {
          window.location.reload();
        }
      } catch (error) {
        alert('Error al eliminar');
      }
    });
  });
</script>
