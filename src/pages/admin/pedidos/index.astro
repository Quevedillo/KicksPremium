---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabase } from '@lib/supabase';

// Filtros desde query params
const url = Astro.url;
const statusFilter = url.searchParams.get('status') || 'all';
const searchQuery = url.searchParams.get('search') || '';

// Query base
let query = supabase
  .from('orders')
  .select('*')
  .order('created_at', { ascending: false });

// Aplicar filtro de estado
if (statusFilter !== 'all') {
  // 'paid' filter also shows legacy 'completed' orders
  if (statusFilter === 'paid') {
    query = query.in('status', ['paid', 'completed']);
  } else {
    query = query.eq('status', statusFilter);
  }
}

const { data: orders, error } = await query;

// Filtrar por b√∫squeda si existe
let filteredOrders = orders || [];
if (searchQuery) {
  const search = searchQuery.toLowerCase();
  filteredOrders = filteredOrders.filter(order => 
    order.id.toLowerCase().includes(search) ||
    order.billing_email?.toLowerCase().includes(search) ||
    order.shipping_name?.toLowerCase().includes(search)
  );
}

// Estad√≠sticas (incluir 'completed' legacy como 'paid')
const stats = {
  total: orders?.length || 0,
  paid: orders?.filter(o => o.status === 'paid' || o.status === 'completed').length || 0,
  processing: orders?.filter(o => o.status === 'processing').length || 0,
  shipped: orders?.filter(o => o.status === 'shipped').length || 0,
  cancelled: orders?.filter(o => o.status === 'cancelled').length || 0,
};

// Formatear moneda
const formatCurrency = (cents: number) => {
  if (!cents || isNaN(cents)) return '0,00 ‚Ç¨';
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(cents / 100);
};

// Formatear fecha
const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('es-ES', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// Estado a badge
const getStatusBadge = (status: string) => {
  const badges: Record<string, { color: string; label: string; icon: string }> = {
    paid: { color: 'bg-blue-100 text-blue-800 border-blue-200', label: 'Pagado', icon: '‚úì' },
    completed: { color: 'bg-blue-100 text-blue-800 border-blue-200', label: 'Pagado', icon: '‚úì' }, // legacy
    processing: { color: 'bg-orange-100 text-orange-800 border-orange-200', label: 'Procesando', icon: '‚öôÔ∏è' },
    shipped: { color: 'bg-purple-100 text-purple-800 border-purple-200', label: 'Enviado', icon: 'üì¶' },
    cancelled: { color: 'bg-red-100 text-red-800 border-red-200', label: 'Cancelado', icon: '‚ùå' },
  };
  return badges[status] || { color: 'bg-neutral-100 text-neutral-800 border-neutral-200', label: status, icon: '?' };
};

const statusOptions = [
  { value: 'all', label: 'Todos' },
  { value: 'paid', label: 'Pagados' },
  { value: 'processing', label: 'Procesando' },
  { value: 'shipped', label: 'Enviados' },
  { value: 'cancelled', label: 'Cancelados' },
];
---

<AdminLayout title="Gesti√≥n de Pedidos" currentPage="pedidos">
  <div class="space-y-6">
    {/* Stats Cards */}
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
      <a
        href="/admin/pedidos"
        class={`p-4 rounded-xl border-2 transition-all h-[100px] flex flex-col justify-center ${statusFilter === 'all' ? 'border-brand-red bg-brand-red/5' : 'border-neutral-200 bg-white hover:border-neutral-300'}`}
      >
        <p class="text-2xl font-bold text-brand-black">{stats.total}</p>
        <p class="text-xs text-neutral-500">Total</p>
      </a>
      <a
        href="/admin/pedidos?status=paid"
        class={`p-4 rounded-xl border-2 transition-all h-[100px] flex flex-col justify-center ${statusFilter === 'paid' ? 'border-blue-500 bg-blue-50' : 'border-neutral-200 bg-white hover:border-blue-200'}`}
      >
        <p class="text-2xl font-bold text-blue-600">{stats.paid}</p>
        <p class="text-xs text-neutral-500">Pagados</p>
      </a>
      <a
        href="/admin/pedidos?status=processing"
        class={`p-4 rounded-xl border-2 transition-all h-[100px] flex flex-col justify-center ${statusFilter === 'processing' ? 'border-orange-500 bg-orange-50' : 'border-neutral-200 bg-white hover:border-orange-200'}`}
      >
        <p class="text-2xl font-bold text-orange-600">{stats.processing}</p>
        <p class="text-xs text-neutral-500">Procesando</p>
      </a>
      <a
        href="/admin/pedidos?status=shipped"
        class={`p-4 rounded-xl border-2 transition-all h-[100px] flex flex-col justify-center ${statusFilter === 'shipped' ? 'border-purple-500 bg-purple-50' : 'border-neutral-200 bg-white hover:border-purple-200'}`}
      >
        <p class="text-2xl font-bold text-purple-600">{stats.shipped}</p>
        <p class="text-xs text-neutral-500">Enviados</p>
      </a>
      <a
        href="/admin/pedidos?status=cancelled"
        class={`p-4 rounded-xl border-2 transition-all h-[100px] flex flex-col justify-center ${statusFilter === 'cancelled' ? 'border-red-500 bg-red-50' : 'border-neutral-200 bg-white hover:border-red-200'}`}
      >
        <p class="text-2xl font-bold text-red-600">{stats.cancelled}</p>
        <p class="text-xs text-neutral-500">Cancelados</p>
      </a>
    </div>

    {/* Search & Filters */}
    <div class="bg-white rounded-xl border border-neutral-200 p-4">
      <form method="GET" class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <input
            type="text"
            name="search"
            value={searchQuery}
            placeholder="Buscar por ID, email o nombre..."
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg bg-white text-brand-black placeholder-neutral-400 focus:outline-none focus:border-brand-red"
          />
        </div>
        <select
          name="status"
          class="px-4 py-2 border border-neutral-300 rounded-lg bg-white text-brand-black placeholder-neutral-400 focus:outline-none focus:border-brand-red"
        >
          {statusOptions.map((opt) => (
            <option value={opt.value} selected={statusFilter === opt.value}>
              {opt.label}
            </option>
          ))}
        </select>
        <button
          type="submit"
          class="px-6 py-2 bg-brand-black text-white font-medium rounded-lg hover:bg-brand-red transition-colors"
        >
          Filtrar
        </button>
      </form>
    </div>

    {/* Orders Table */}
    {filteredOrders.length > 0 ? (
      <div class="bg-white rounded-xl border border-neutral-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-neutral-50 border-b border-neutral-200">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">
                  Pedido
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">
                  Cliente
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">
                  Items
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">
                  Total
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">
                  Estado
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-600 uppercase tracking-wider">
                  Fecha
                </th>
                <th class="px-6 py-4 text-right text-xs font-semibold text-neutral-600 uppercase tracking-wider">
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neutral-100">
              {filteredOrders.map((order) => {
                const badge = getStatusBadge(order.status);
                const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
                const itemCount = Array.isArray(items) ? items.reduce((sum: number, item: any) => sum + (item.quantity || item.qty || item.q || 1), 0) : 0;
                const orderTotal = order.total_amount || 0;
                
                return (
                  <tr class="hover:bg-neutral-50 transition-colors">
                    <td class="px-6 py-4">
                      <p class="font-mono text-sm font-semibold text-brand-black">
                        #{order.id.slice(0, 8)}
                      </p>
                      {order.stripe_session_id && (
                        <p class="text-xs text-neutral-400 truncate max-w-[120px]">
                          Stripe: {order.stripe_session_id.slice(0, 12)}...
                        </p>
                      )}
                    </td>
                    <td class="px-6 py-4">
                      <p class="font-medium text-brand-black">
                        {order.shipping_name || 'Sin nombre'}
                      </p>
                      <p class="text-sm text-neutral-500">
                        {order.billing_email || 'Sin email'}
                      </p>
                    </td>
                    <td class="px-6 py-4">
                      <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-neutral-100 text-neutral-700">
                        {itemCount} {itemCount === 1 ? 'producto' : 'productos'}
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <p class="font-bold text-brand-black">
                        {formatCurrency(orderTotal)}
                      </p>
                    </td>
                    <td class="px-6 py-4">
                      <span class={`inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium border ${badge.color}`}>
                        <span>{badge.icon}</span>
                        {badge.label}
                      </span>
                      {order.status === 'processing' && order.cancelled_reason && (
                        <span class="block mt-1 text-xs text-amber-600 font-medium">‚ö†Ô∏è Cancelaci√≥n pendiente</span>
                      )}
                    </td>
                    <td class="px-6 py-4">
                      <p class="text-sm text-neutral-600">
                        {formatDate(order.created_at)}
                      </p>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="flex items-center justify-end gap-2">
                        <a
                          href={`/api/admin/orders/${order.id}/invoice`}
                          target="_blank"
                          class="px-2 py-1.5 text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-lg transition-colors flex items-center gap-1"
                          title="Descargar factura"
                        >
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                          </svg>
                          PDF
                        </a>
                        {order.status === 'cancelled' && order.cancelled_reason && (
                          <button
                            onclick={`alert('Motivo de cancelaci√≥n:\\n\\n${order.cancelled_reason}')`}
                            class="px-2 py-1.5 text-xs font-medium bg-red-100 text-red-700 hover:bg-red-200 rounded-lg transition-colors flex items-center gap-1"
                            title="Ver motivo de cancelaci√≥n"
                          >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Motivo
                          </button>
                        )}
                        <a
                          href={`/admin/pedidos/${order.id}`}
                          class="px-3 py-1.5 text-xs font-medium text-brand-black hover:text-brand-red transition-colors"
                        >
                          Ver detalles
                        </a>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    ) : (
      <div class="bg-white rounded-xl border border-neutral-200 p-12 text-center">
        <svg class="w-16 h-16 text-neutral-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        <h3 class="text-lg font-semibold text-brand-black mb-2">No hay pedidos</h3>
        <p class="text-neutral-500">
          {searchQuery || statusFilter !== 'all' 
            ? 'No se encontraron pedidos con esos filtros.' 
            : 'A√∫n no se han recibido pedidos en la tienda.'}
        </p>
        {(searchQuery || statusFilter !== 'all') && (
          <a
            href="/admin/pedidos"
            class="inline-block mt-4 px-4 py-2 text-sm font-medium text-brand-red hover:text-brand-orange"
          >
            Limpiar filtros
          </a>
        )}
      </div>
    )}
  </div>
</AdminLayout>
